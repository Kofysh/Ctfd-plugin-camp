{% extends "admin/base.html" %}

{% block content %}
<div class="jumbotron">
    <div class="container">
        <h1>üéØ Gestion des Camps</h1>
        <p class="lead">Configuration du syst√®me Bleu vs Rouge</p>
        <a href="/admin/camps/logs" class="btn btn-warning">
            <i class="fas fa-shield-alt"></i> Voir les logs de s√©curit√©
        </a>
    </div>
</div>

<div class="container">
    <!-- Configuration -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h3>‚öôÔ∏è Configuration</h3>
                </div>
                <div class="card-body">
                    <form id="config-form">
                        <div class="form-group">
                            <div class="custom-control custom-switch">
                                <input type="checkbox" class="custom-control-input" id="allow-change" 
                                       {% if config.allow_change %}checked{% endif %}>
                                <label class="custom-control-label" for="allow-change">
                                    <strong>Autoriser le changement de camp</strong>
                                    <br><small class="text-muted">Si d√©sactiv√©, une fois le camp choisi, il ne peut plus √™tre modifi√©</small>
                                </label>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <div class="custom-control custom-switch">
                                <input type="checkbox" class="custom-control-input" id="show-public-stats" 
                                       {% if config.show_public_stats %}checked{% endif %}>
                                <label class="custom-control-label" for="show-public-stats">
                                    <strong>Afficher publiquement le nombre d'√©quipes par camp</strong>
                                    <br><small class="text-muted">Les √©quipes verront les statistiques sur /camps/select</small>
                                </label>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <div class="custom-control custom-switch">
                                <input type="checkbox" class="custom-control-input" id="show-challenge-badges" 
                                       {% if config.show_challenge_badges %}checked{% endif %}>
                                <label class="custom-control-label" for="show-challenge-badges">
                                    <strong>Afficher les pastilles de camp sur les challenges</strong>
                                    <br><small class="text-muted">Une petite bulle color√©e üîµ/üî¥ appara√Ætra en bas √† gauche de chaque challenge</small>
                                </label>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <div class="custom-control custom-switch">
                                <input type="checkbox" class="custom-control-input" id="enable-team-limits" 
                                       {% if config.enable_team_limits %}checked{% endif %}>
                                <label class="custom-control-label" for="enable-team-limits">
                                    <strong>Limiter le nombre d'√©quipes par camp</strong>
                                    <br><small class="text-muted">Emp√™che les √©quipes de rejoindre un camp une fois le quota atteint</small>
                                </label>
                            </div>
                        </div>
                        
                        <div id="team-limits-fields" style="display: {% if config.enable_team_limits %}block{% else %}none{% endif %};">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="max-blue-teams">üîµ <strong>Maximum Camp Bleu</strong></label>
                                        <input type="number" class="form-control" id="max-blue-teams" min="0" 
                                               value="{{ config.max_blue_teams }}" placeholder="0 = illimit√©">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="max-red-teams">üî¥ <strong>Maximum Camp Rouge</strong></label>
                                        <input type="number" class="form-control" id="max-red-teams" min="0" 
                                               value="{{ config.max_red_teams }}" placeholder="0 = illimit√©">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="deadline"><strong>Date limite de changement</strong></label>
                            <input type="datetime-local" class="form-control" id="deadline" 
                                   value="{{ config.deadline[:16] if config.deadline else '' }}">
                            <small class="form-text text-muted">
                                Apr√®s cette date, aucun changement ne sera possible, m√™me si l'option est activ√©e
                            </small>
                        </div>
                        
                        {% if config.deadline %}
                        <div class="alert {% if config.deadline_passed %}alert-danger{% else %}alert-success{% endif %}">
                            {% if config.deadline_passed %}
                                üî¥ <strong>Date limite d√©pass√©e</strong> - Les changements de camp sont bloqu√©s
                            {% else %}
                                üü¢ <strong>Changements autoris√©s</strong> jusqu'au {{ config.deadline[:16].replace('T', ' ') }}
                            {% endif %}
                        </div>
                        {% endif %}
                        
                        <button type="submit" class="btn btn-primary">üíæ Sauvegarder la configuration</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistiques -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-white bg-primary">
                <div class="card-body">
                    <h5 class="card-title">üîµ Camp Bleu</h5>
                    <h2>{{ stats.blue }}</h2>
                    <p class="mb-0">√©quipes</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-danger">
                <div class="card-body">
                    <h5 class="card-title">üî¥ Camp Rouge</h5>
                    <h2>{{ stats.red }}</h2>
                    <p class="mb-0">√©quipes</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-secondary">
                <div class="card-body">
                    <h5 class="card-title">‚ö™ Non assign√©es</h5>
                    <h2>{{ stats.unassigned }}</h2>
                    <p class="mb-0">√©quipes</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-dark">
                <div class="card-body">
                    <h5 class="card-title">üìä Total</h5>
                    <h2>{{ stats.total }}</h2>
                    <p class="mb-0">√©quipes</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Liste des √©quipes -->
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h3>Gestion des √©quipes</h3>
                </div>
                <div class="card-body">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nom de l'√©quipe</th>
                                <th>Camp actuel</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for team in teams %}
                            <tr id="team-{{ team.id }}">
                                <td>{{ team.id }}</td>
                                <td>{{ team.name }}</td>
                                <td>
                                    <span class="badge badge-pill 
                                        {% if team.camp == 'blue' %}badge-primary
                                        {% elif team.camp == 'red' %}badge-danger
                                        {% else %}badge-secondary{% endif %}">
                                        {% if team.camp == 'blue' %}üîµ Camp Bleu
                                        {% elif team.camp == 'red' %}üî¥ Camp Rouge
                                        {% else %}‚ö™ Non assign√©{% endif %}
                                    </span>
                                </td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <button class="btn btn-sm btn-primary" onclick="updateCamp({{ team.id }}, 'blue')">
                                            üîµ Bleu
                                        </button>
                                        <button class="btn btn-sm btn-danger" onclick="updateCamp({{ team.id }}, 'red')">
                                            üî¥ Rouge
                                        </button>
                                        <button class="btn btn-sm btn-secondary" onclick="updateCamp({{ team.id }}, 'none')">
                                            ‚ùå Retirer
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Afficher/masquer les champs de limite selon la checkbox
document.getElementById('enable-team-limits').addEventListener('change', function() {
    document.getElementById('team-limits-fields').style.display = this.checked ? 'block' : 'none';
});

// Sauvegarder la configuration
document.getElementById('config-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const allowChange = document.getElementById('allow-change').checked;
    const showPublicStats = document.getElementById('show-public-stats').checked;
    const showChallengeBadges = document.getElementById('show-challenge-badges').checked;
    const enableTeamLimits = document.getElementById('enable-team-limits').checked;
    const maxBlueTeams = parseInt(document.getElementById('max-blue-teams').value) || 0;
    const maxRedTeams = parseInt(document.getElementById('max-red-teams').value) || 0;
    const deadline = document.getElementById('deadline').value;
    
    // Convertir en format ISO si une date est s√©lectionn√©e
    let deadlineISO = '';
    if (deadline) {
        deadlineISO = new Date(deadline).toISOString();
    }
    
    fetch('/admin/camps/config', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'CSRF-Token': window.init.csrfNonce
        },
        body: JSON.stringify({
            allow_change: allowChange,
            show_public_stats: showPublicStats,
            show_challenge_badges: showChallengeBadges,
            enable_team_limits: enableTeamLimits,
            max_blue_teams: maxBlueTeams,
            max_red_teams: maxRedTeams,
            deadline: deadlineISO
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('‚úÖ Configuration sauvegard√©e !');
            location.reload();
        } else {
            alert('‚ùå Erreur: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        alert('‚ùå Erreur lors de la sauvegarde');
    });
});

// Mettre √† jour le camp d'une √©quipe
function updateCamp(teamId, camp) {
    if (!['blue', 'red', 'none'].includes(camp)) {
        alert('Camp invalide');
        return;
    }
    
    fetch(`/admin/camps/team/${teamId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'CSRF-Token': window.init.csrfNonce
        },
        body: JSON.stringify({ camp: camp })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Erreur: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        alert('Erreur lors de la mise √† jour');
    });
}
</script>
{% endblock %}