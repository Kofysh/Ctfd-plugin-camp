{% extends "base.html" %}

{% block content %}
<div class="jumbotron">
    <div class="container">
        <h1>ğŸ¯ Choix du Camp</h1>
        <p class="lead">Choisissez votre camp pour participer au CTF</p>
    </div>
</div>

<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-10">
            
            <!-- Statut actuel -->
            {% if current_camp %}
            <div class="alert alert-info">
                <h4>Votre camp actuel :</h4>
                <h2>
                    {% if current_camp == 'blue' %}
                        ğŸ”µ <strong>Camp Bleu</strong> (DÃ©fenseurs)
                    {% elif current_camp == 'red' %}
                        ğŸ”´ <strong>Camp Rouge</strong> (Attaquants)
                    {% endif %}
                </h2>
            </div>
            {% else %}
            <div class="alert alert-warning">
                <h4>âš ï¸ Aucun camp sÃ©lectionnÃ©</h4>
                <p>Vous devez choisir un camp pour accÃ©der aux challenges !</p>
            </div>
            {% endif %}
            
            <!-- Info deadline SEULEMENT si l'option est activÃ©e -->
            {% if deadline and allow_change %}
            <div class="alert {% if can_change %}alert-warning{% else %}alert-danger{% endif %} mt-2">
                <strong>â° {% if can_change %}Attention{% else %}Date limite dÃ©passÃ©e{% endif %} :</strong> 
                {% if can_change %}
                    Vous pouvez changer de camp jusqu'au <strong>{{ deadline }}</strong>
                {% else %}
                    La date limite Ã©tait le <strong>{{ deadline }}</strong>
                {% endif %}
            </div>
            {% endif %}
            
            <!-- Message d'erreur si changement bloquÃ© -->
            {% if not can_change %}
            <div class="alert alert-danger">
                <h4>ğŸ”’ Changement de camp bloquÃ©</h4>
                <p>{{ change_error }}</p>
            </div>
            {% endif %}
            
            <!-- SÃ©lection de camp -->
            <div class="row mt-4">
                <div class="col-md-6 mb-3">
                    <div class="card border-primary {% if current_camp == 'blue' %}bg-light{% endif %}" style="height: 100%;">
                        <div class="card-body text-center">
                            <h2 class="card-title">ğŸ”µ Camp Bleu</h2>
                            <h5 class="text-muted">DÃ©fenseurs</h5>
                            <p class="card-text mt-3">
                                ProtÃ©gez les systÃ¨mes et infrastructures contre les attaques.
                                Analysez les logs, renforcez la sÃ©curitÃ©, dÃ©tectez les intrusions.
                            </p>
                            <ul class="list-unstyled mt-3">
                                <li>ğŸ›¡ï¸ Challenges de dÃ©fense</li>
                                <li>ğŸ” Analyse forensics</li>
                                <li>ğŸš¨ DÃ©tection d'incidents</li>
                            </ul>
                            {% if current_camp == 'blue' %}
                                <button class="btn btn-primary btn-lg mt-3" disabled>âœ“ Camp actuel</button>
                            {% elif not can_change %}
                                <button class="btn btn-outline-primary btn-lg mt-3" disabled>ğŸ”’ Changement bloquÃ©</button>
                            {% else %}
                                <button class="btn btn-outline-primary btn-lg mt-3" onclick="selectCamp('blue')">
                                    Rejoindre le Camp Bleu
                                </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6 mb-3">
                    <div class="card border-danger {% if current_camp == 'red' %}bg-light{% endif %}" style="height: 100%;">
                        <div class="card-body text-center">
                            <h2 class="card-title">ğŸ”´ Camp Rouge</h2>
                            <h5 class="text-muted">Attaquants</h5>
                            <p class="card-text mt-3">
                                Exploitez les vulnÃ©rabilitÃ©s et pÃ©nÃ©trez les systÃ¨mes adverses.
                                Trouvez les failles, dÃ©veloppez des exploits, contournez les protections.
                            </p>
                            <ul class="list-unstyled mt-3">
                                <li>âš”ï¸ Challenges d'attaque</li>
                                <li>ğŸ’‰ Exploitation de vulnÃ©rabilitÃ©s</li>
                                <li>ğŸ¯ Pentest offensif</li>
                            </ul>
                            {% if current_camp == 'red' %}
                                <button class="btn btn-danger btn-lg mt-3" disabled>âœ“ Camp actuel</button>
                            {% elif not can_change %}
                                <button class="btn btn-outline-danger btn-lg mt-3" disabled>ğŸ”’ Changement bloquÃ©</button>
                            {% else %}
                                <button class="btn btn-outline-danger btn-lg mt-3" onclick="selectCamp('red')">
                                    Rejoindre le Camp Rouge
                                </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            
        </div>
    </div>
</div>

<script>
function selectCamp(camp) {
    if (!['blue', 'red'].includes(camp)) {
        alert('Camp invalide');
        return;
    }
    
    if (!confirm(`ÃŠtes-vous sÃ»r de vouloir rejoindre le camp ${camp === 'blue' ? 'Bleu' : 'Rouge'} ?`)) {
        return;
    }
    
    fetch('/api/v1/camps/select', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'CSRF-Token': window.init.csrfNonce
        },
        body: JSON.stringify({ camp: camp })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('âœ… ' + data.message);
            location.reload();
        } else {
            alert('âŒ Erreur: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        alert('âŒ Erreur lors de la sÃ©lection du camp');
    });
}
</script>
{% endblock %}